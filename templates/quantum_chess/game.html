{% extends 'quantum_chess/base.html' %}

{% block title %}Quantum Chess - Game {{ game.id }}{% endblock %}

{% block extra_css %}
<style>
    #board {
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
    }
    
    .game-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .quantum-toggle {
        position: relative;
        width: 60px;
        height: 30px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .quantum-toggle.active {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .quantum-toggle::after {
        content: '';
        position: absolute;
        top: 2px;
        left: 2px;
        width: 26px;
        height: 26px;
        background: white;
        border-radius: 50%;
        transition: all 0.3s;
    }
    
    .quantum-toggle.active::after {
        left: 32px;
    }
    
    .game-status {
        font-size: 1.2em;
        font-weight: bold;
    }
    
    .piece-info {
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        padding: 10px;
        margin-top: 10px;
    }
</style>
{% endblock %}

{% block content %}
<div class="game-container">
    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="game-status">
                        {% if game.current_turn %}White's Turn{% else %}Black's Turn{% endif %}
                    </span>
                    <div class="d-flex align-items-center gap-3">
                        <span>Quantum Mode:</span>
                        <div class="quantum-toggle {% if game.quantum_mode %}active{% endif %}" id="quantumToggle"></div>
                    </div>
                </div>
                <div class="card-body">
                    <div id="board"></div>
                </div>

                <div class="card-footer">
                    <div class="d-flex justify-content-between">
                        <button class="btn btn-outline-light" id="flipBoard">Flip Board</button>
                        <button class="btn btn-outline-light" id="resetGame">New Game</button>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Instructions</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li><strong>Click</strong> a piece to select it</li>
                        <li><strong>Click</strong> a square to move</li>
                        <li>Hold <strong>Shift</strong> or click Quantum Mode for quantum moves</li>
                        <li>In quantum mode, you can split pieces or entangle them</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Game Info</h5>
                </div>
                <div class="card-body">
                    <div class="game-info mb-3">
                        <p><strong>Game ID:</strong> {{ game.id }}</p>
                        <p><strong>Status:</strong> {{ game.get_status_display }}</p>
                        <p><strong>FEN:</strong> <small id="gameFen">{{ game.fen_position }}</small></p>

                    </div>
                    
                    <h6>Move History</h6>
                    <div class="move-history" id="moveHistory">
                        <p class="text-muted">No moves yet</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Quantum Pieces</h5>
                </div>
                <div class="card-body">
                    <div id="quantumPieces">
                        <p class="text-muted">No quantum pieces</p>
                    </div>
                </div>
            </div>
            
            <div class="card mt-3" id="quantumControls" style="display: none;">
                <div class="card-header">
                    <h5 class="mb-0">Quantum Controls</h5>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">Select a piece, then choose two target squares for superposition.</p>
                    <button class="btn btn-sm btn-outline-info w-100 mb-2" id="cancelQuantum">Cancel</button>
                </div>
            </div>

            
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0">Legend</h5>
                </div>
                <div class="card-body">
                    <ul class="mb-0 small">
                        <li>üéØ <strong>Click</strong> - Select piece</li>
                        <li>‚¨áÔ∏è <strong>Click</strong> - Move to square</li>
                        <li>üîÆ <strong>Shift</strong> - Quantum mode</li>
                        <li>üìä <strong>Split</strong> - Two positions</li>
                        <li>‚õìÔ∏è <strong>Entangle</strong> - Link pieces</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Game configuration
    var gameId = {{ game.id }};
    var board = null;
    var game = new Chess('{{ game.fen_position }}');
    var quantumMode = {{ game.quantum_mode|yesno:"true,false" }};
    var quantumPieces = {{ game.quantum_pieces|safe|default:"[]" }};
    var $status = $('#status');
    var $fen = $('#fen');
    var $pgn = $('#pgn');
    
    // Quantum split state
    var quantumSplitState = {
        active: false,
        fromSquare: null,
        firstTarget: null
    };
    
    // Initialize board
    function onDragStart (source, piece, position, orientation) {
        // Do not pick up pieces if the game is over
        if (game.game_over()) return false;

        // Only pick up pieces for the side to move
        if ((game.turn() === 'w' && piece.search(/^b/) !== -1) ||
            (game.turn() === 'b' && piece.search(/^w/) !== -1)) {
            return false;
        }
        
        // In quantum split mode, handle differently
        if (quantumMode && quantumSplitState.active) {
            return false; // Don't allow dragging in quantum split mode
        }
    }
    
    function onDrop (source, target) {
        // Check if we're in quantum mode and doing a split
        if (quantumMode && quantumSplitState.active) {
            handleQuantumSplitDrop(source, target);
            return 'snapback';
        }
        
        // Check if this is a promotion move (pawn reaching last rank)
        var piece = game.get(source);
        var isPromotion = piece && piece.type === 'p' && (target[1] === '8' || target[1] === '1');
        
        // Normal move
        var moveConfig = {
            from: source,
            to: target
        };
        if (isPromotion) {
            moveConfig.promotion = 'q';
        }
        
        var move = game.move(moveConfig);

        // Illegal move
        if (move === null) return 'snapback';

        updateStatus();
        updateBoard();
        
        // Send move to server
        var moveData = {
            game_id: gameId,
            from_square: source,
            to_square: target,
            quantum_mode: quantumMode
        };
        if (isPromotion) {
            moveData.promotion = 'q';
        }
        
        $.ajax({
            url: '{% url "quantum_chess:make_move" %}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(moveData),

            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Move saved:', response);
                if (response.fen) {
                    game.load(response.fen);
                    board.position(response.fen);
                    // Update FEN display
                    $('#gameFen').text(response.fen);
                }
                // Update move history after successful move
                loadGameState();
            },


            error: function(error) {
                console.error('Error saving move:', error);
                console.error('Error response:', error.responseText);
                console.error('Error status:', error.status);
                // Log the move that failed
                console.log('Failed move attempt:', {
                    from: source,
                    to: target,
                    gameTurn: game.turn(),
                    fen: game.fen()
                });
            }

        });
    }
    
    function handleQuantumSplitDrop(source, target) {
        if (!quantumSplitState.fromSquare) {
            // First selection - the piece to split
            var piece = game.get(source);
            if (!piece) {
                alert('No piece at this square!');
                return;
            }
            quantumSplitState.fromSquare = source;
            highlightSquare(source, 'selected');
            $('#quantumControls .card-body').html(
                '<p class="text-info">Piece selected: ' + source + '</p>' +
                '<p class="small text-muted">Now click first target square</p>' +
                '<button class="btn btn-sm btn-outline-info w-100" id="cancelQuantum">Cancel</button>'
            );
        } else if (!quantumSplitState.firstTarget) {
            // Second selection - first target
            quantumSplitState.firstTarget = target;
            highlightSquare(target, 'target1');
            $('#quantumControls .card-body').html(
                '<p class="text-info">First target: ' + target + '</p>' +
                '<p class="small text-muted">Now click second target square</p>' +
                '<button class="btn btn-sm btn-outline-info w-100" id="cancelQuantum">Cancel</button>'
            );
        } else {
            // Third selection - second target, perform split
            performQuantumSplit(quantumSplitState.fromSquare, quantumSplitState.firstTarget, target);
        }
    }
    
    function performQuantumSplit(from, to1, to2) {
        $.ajax({
            url: '{% url "quantum_chess:quantum_split" %}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                game_id: gameId,
                from_square: from,
                to_square1: to1,
                to_square2: to2
            }),
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            },
            success: function(response) {
                console.log('Quantum split performed:', response);
                console.log('Server turn:', response.turn, 'Current game turn:', game.turn());
                
                if (response.fen) {
                    // Load the new position - this updates game.turn() and board
                    game.load(response.fen);
                    // Don't call board.position() separately - it causes flicker
                    // The board will update via chessboard.js internal state
                    console.log('After loading FEN, game turn is now:', game.turn());
                    // Update FEN display
                    $('#gameFen').text(response.fen);
                }

                if (response.quantum_pieces) {
                    quantumPieces = response.quantum_pieces;
                    updateQuantumPiecesDisplay();
                    // Delay rendering to ensure board is ready
                    setTimeout(renderQuantumPiecesOnBoard, 100);
                }
                // Update turn display from server
                if (response.turn) {
                    var turnText = response.turn === 'white' ? "White's Turn" : "Black's Turn";
                    $('.game-status').text(turnText);
                    console.log('Updated status to:', turnText);
                }
                
                // Turn off quantum mode after successful split
                quantumMode = false;
                $('#quantumToggle').removeClass('active');
                board.draggable = true; // Re-enable dragging
                
                // Reset quantum state and clear highlights
                resetQuantumSplitState();
                
                // Update move history after quantum split
                loadGameState();
                // Don't call updateStatus() here - it would overwrite our turn display
            },






            error: function(error) {
                console.error('Error performing quantum split:', error);
                alert('Quantum split failed: ' + (error.responseJSON?.error || 'Unknown error'));
                resetQuantumSplitState();
            }
        });
    }
    
    function resetQuantumSplitState() {
        quantumSplitState = {
            active: false,
            fromSquare: null,
            firstTarget: null
        };
        $('#quantumControls').hide();
        clearHighlights();
        // Re-enable dragging
        board.draggable = true;
    }

    
    function highlightSquare(square, type) {
        var $square = $('#board .square-' + square);
        var color = type === 'selected' ? '#f093fb' : (type === 'target1' ? '#f5576c' : '#4facfe');
        $square.css('background', color);
    }
    
    function clearHighlights() {
        // Clear all square backgrounds - highlights are set via inline CSS
        $('#board [class*="square-"]').css('background', '');
        // Also remove any highlight classes if they exist
        $('#board .square-55d, #board .square-55l').css('background', '');
    }

    
    function updateBoard() {
        board.position(game.fen());
    }
    
    // Update the board position after the piece snap
    function onSnapEnd () {
        board.position(game.fen());
    }
    
    function updateStatus () {
        var status = '';
        var moveColor = 'White';
        
        if (game.turn() === 'b') {
            moveColor = 'Black';
        }
        
        // Checkmate?
        if (game.in_checkmate()) {
            status = 'Game over, ' + moveColor + ' is in checkmate.';
        }
        
        // Draw?
        else if (game.in_draw()) {
            status = 'Game over, drawn position';
        }
        
        // Game still on
        else {
            status = moveColor + "'s turn";
            
            // Is player in check?
            if (game.in_check()) {
                status += ', ' + moveColor + ' is in check';
            }
        }
        
        $('.game-status').text(status);
    }
    
    function updateQuantumPiecesDisplay() {
        var $container = $('#quantumPieces');
        if (!quantumPieces || quantumPieces.length === 0) {
            $container.html('<p class="text-muted">No quantum pieces</p>');
            return;
        }
        
        var html = '';
        quantumPieces.forEach(function(qp, index) {
            html += '<div class="quantum-piece">';
            html += '<strong>Piece: ' + qp.piece + '</strong><br>';
            html += '<small>States:</small><br>';
            for (var state in qp.qnum) {
                var pos = qp.qnum[state][0];
                var prob = Math.round(qp.qnum[state][1] * 100);
                html += '<span class="quantum-position">' + pos + ' (' + prob + '%)</span>';
            }
            html += '</div>';
        });
        $container.html(html);
    }
    
    function updateMoveHistory(moves) {
        var $container = $('#moveHistory');
        if (!moves || moves.length === 0) {
            $container.html('<p class="text-muted">No moves yet</p>');
            return;
        }
        
        var html = '<ul class="list-unstyled mb-0">';
        moves.forEach(function(move) {
            var moveText = move.number + '. ' + (move.is_white ? '' : '...') + move.san;
            var badgeClass = move.type === 'split' ? 'badge-info' : (move.type === 'quantum' ? 'badge-warning' : 'badge-secondary');
            html += '<li class="mb-1"><span class="badge ' + badgeClass + ' mr-1">' + move.type + '</span> ' + moveText + '</li>';
        });
        html += '</ul>';
        $container.html(html);
    }

    
    // Convert piece symbol to chessboard.js format (e.g., 'P' -> 'wP', 'p' -> 'bP')
    function getPieceImageName(piece) {
        if (!piece) return null;
        var pieceUpper = piece.toUpperCase();
        var isWhite = piece === pieceUpper; // Uppercase = white
        var color = isWhite ? 'w' : 'b';
        return color + pieceUpper;
    }
    
    // Render quantum pieces on the board as ghost pieces
    function renderQuantumPiecesOnBoard() {
        // Clear any existing quantum piece indicators
        $('#board .quantum-ghost').remove();
        
        if (!quantumPieces || quantumPieces.length === 0) return;
        
        var pieceTheme = 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png';
        
        // Debug: log board structure
        console.log('Board element:', $('#board')[0]);
        console.log('Board children count:', $('#board').children().length);
        
        quantumPieces.forEach(function(qp) {
            for (var state in qp.qnum) {
                var pos = qp.qnum[state][0];
                var prob = qp.qnum[state][1];
                var piece = qp.piece;
                
                // Convert piece to chessboard.js format (e.g., 'P' -> 'wP', 'p' -> 'bP')
                var pieceImage = getPieceImageName(piece);
                if (!pieceImage) {
                    console.log('Invalid piece symbol:', piece);
                    continue;
                }
                
                // chessboard.js creates elements with class pattern like "square-a1"
                // Try to find by looking for elements with the square class
                var $square = $('#board').find('[class*="square-' + pos + '"]');
                
                if ($square.length === 0) {
                    console.log('Could not find square for quantum piece:', pos);
                    // Log all available square classes for debugging
                    var allSquares = $('#board [class*="square-"]').map(function() { 
                        return $(this).attr('class'); 
                    }).get();
                    console.log('Available square classes:', allSquares.slice(0, 10), '...');
                    continue;
                }
                
                console.log('Rendering quantum piece at:', pos, 'piece:', piece, 'image:', pieceImage, 'prob:', prob);
                // Create ghost piece image
                var $ghost = $('<img>')
                    .addClass('quantum-ghost')
                    .attr('src', pieceTheme.replace('{piece}', pieceImage))
                    .css({
                        'position': 'absolute',
                        'width': '50%',
                        'height': '50%',
                        'opacity': prob,
                        'pointer-events': 'none',
                        'z-index': 100,
                        'top': '25%',
                        'left': '25%'
                    });
                
                // Position the ghost piece
                $square.css('position', 'relative');
                $square.append($ghost);
            }
        });
    }





    
    function loadGameState() {
        $.ajax({
            url: '{% url "quantum_chess:game_state" game.id %}',

            method: 'GET',
            success: function(response) {
                if (response.fen) {
                    // Only update if FEN is different to avoid flicker
                    var currentFen = game.fen();
                    if (response.fen !== currentFen) {
                        game.load(response.fen);
                        board.position(response.fen);
                    }
                    // Update FEN display
                    $('#gameFen').text(response.fen);
                }

                if (response.quantum_pieces) {
                    quantumPieces = response.quantum_pieces;
                    updateQuantumPiecesDisplay();
                    renderQuantumPiecesOnBoard();
                }
                // Update turn from server
                if (response.turn) {
                    var turnText = response.turn === 'white' ? "White's Turn" : "Black's Turn";
                    $('.game-status').text(turnText);
                }
                // Update move history
                if (response.moves) {
                    updateMoveHistory(response.moves);
                }
                // Don't call updateStatus() here as it may overwrite server turn info

            },
            error: function(error) {
                console.error('Error loading game state:', error);
            }
        });
    }


    
    // Initialize
    $(document).ready(function() {
        var config = {
            draggable: true,
            position: '{{ game.fen_position }}',
            onDragStart: onDragStart,
            onDrop: onDrop,
            onSnapEnd: onSnapEnd,
            pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png'
        };
        
        board = Chessboard('board', config);
        
        // Initialize quantum pieces display
        updateQuantumPiecesDisplay();
        
        // Flip button
        $('#flipBoard').on('click', function() {
            board.flip();
        });
        
        // Reset button
        $('#resetGame').on('click', function() {
            window.location.href = '{% url "quantum_chess:new_game" %}';
        });
        
        // Quantum mode toggle
        $('#quantumToggle').on('click', function() {
            quantumMode = !quantumMode;
            $(this).toggleClass('active', quantumMode);
            
            // Enable/disable dragging based on quantum mode
            board.draggable = !quantumMode;
            
            // Show/hide quantum controls
            if (quantumMode) {
                $('#quantumControls').show();
                quantumSplitState.active = true;
                $('#quantumControls .card-body').html(
                    '<p class="text-info">Quantum Mode Active</p>' +
                    '<p class="small text-muted">Click a piece to start quantum split</p>' +
                    '<button class="btn btn-sm btn-outline-info w-100" id="cancelQuantum">Cancel</button>'
                );
            } else {
                resetQuantumSplitState();
            }

            
            // Send quantum mode to server
            $.ajax({
                url: '{% url "quantum_chess:toggle_quantum_mode" %}',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    game_id: gameId,
                    quantum_mode: quantumMode
                }),
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                success: function(response) {
                    console.log('Quantum mode toggled:', response);
                },
                error: function(error) {
                    console.error('Error toggling quantum mode:', error);
                }
            });
        });
        
        // Cancel quantum split
        $(document).on('click', '#cancelQuantum', function() {
            resetQuantumSplitState();
            // Re-enable dragging when canceling quantum mode
            board.draggable = true;
        });

        
        // Keyboard handler for quantum mode
        $(document).on('keydown', function(e) {
            if (e.key === 'Shift') {
                $('#quantumToggle').trigger('click');
            }
        });
        
        // Global board click handler for quantum split - captures all clicks on the board
        $('#board').on('click', function(e) {
            if (!quantumMode || !quantumSplitState.active) {
                return; // Let normal clicks pass through
            }
            
            // Prevent chessboard.js from handling this
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();
            
            // Calculate which square was clicked based on position
            var $board = $(this);
            var offset = $board.offset();
            var x = e.pageX - offset.left;
            var y = e.pageY - offset.top;
            
            var boardWidth = $board.width();
            var squareSize = boardWidth / 8;
            
            var file = Math.floor(x / squareSize);
            var rank = 7 - Math.floor(y / squareSize); // Rank 0 is at the bottom
            
            if (file >= 0 && file < 8 && rank >= 0 && rank < 8) {
                var files = ['a', 'b', 'c', 'd', 'e', 'f', 'g', 'h'];
                var square = files[file] + (rank + 1);
                
                console.log('Quantum split click at:', x, y, 'Square:', square, 'State:', JSON.stringify(quantumSplitState));
                
                // Determine source and target based on current state
                var source, target;
                if (!quantumSplitState.fromSquare) {
                    // First click - selecting the piece to split
                    source = square;
                    target = square;
                } else {
                    // Second or third click - selecting target squares
                    source = quantumSplitState.fromSquare;
                    target = square;
                }
                handleQuantumSplitDrop(source, target);
            }
            
            return false;
        });







        
        updateStatus();
    });
</script>
{% endblock %}
